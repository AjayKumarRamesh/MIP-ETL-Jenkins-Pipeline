pipeline {
    agent { label 'kube_pod_slave' }
    environment {
        BODY_TEXT = ''
    }

    stages {
        /*stage('GitHub Checkout') {
            git credentialsId: 'sangita_id_rsa' ,
            url: 'ssh://git@github.ibm.com/CIO-MAP/Jenkins_Poc_mapetl.git', branch: 'master'  
        }*/
        stage('Kickoff Jobs') {
            steps {
                script{
                    def builds = [:]
                    def build_results = [:]
                    echo "${env.BUILD_USER_EMAIL}"
                    echo "${build_results.getClass()}"
                    def names = "${JOB_NAMES}".split('\n')
                    //echo "${names.getClass()}"

                    for (x in names) {
                        def name = x

                        builds[name] = buildClosure(name, build_results)
                        //def temp_build = builds[name]
                        //echo "${temp_build.getClass()}"
                    }
                    parallel builds

                    def tmp_text = buildBody(names, build_results)
                    BODY_TEXT = tmp_text
                    /*for (name in names) {
                        def key = name
                        tmp_text += key + " - Build " + build_results[key].getDisplayName() + " - " + build_results[key].getResult()

                        if (build_results[key].getResult() == 'FAILURE') {
                            tmp_text += ": Check console output at " + build_results[key].getAbsoluteUrl() + " to view the results.\n"
                        } else {
                            tmp_text += "\n"
                        }
                    } */
                }
            }
        }
        stage('Email Build Results') {
            steps {
                script {
                    emailext to: "${env.BUILD_USER_EMAIL},${env.dev_build_manager}",
                    subject: "${env.JOB_BASE_NAME} - Build # ${env.BUILD_NUMBER} - ${currentBuild.currentResult}!",
                    body: BODY_TEXT
                }
            }
        }
    }
}


def buildBody(String[] names, LinkedHashMap build_results) {
    def tmp_text = ''
    for (name in names) {
        def key = name
        tmp_text += key + " - Build " + build_results[key].getDisplayName() + " - " + build_results[key].getResult()

        if (build_results[key].getResult() == 'FAILURE') {
            tmp_text += ": Check console output at " + build_results[key].getAbsoluteUrl() + " to view the results.\n"
        } else {
            tmp_text += "\n"
        }
    }
    return tmp_text
}

/*
def sendEmail(String[] names, LinkedHashMap build_results) {
    emailext to: "caseyboerst@ibm.com",
    subject: "${env.JOB_BASE_NAME} - Build # ${env.BUILD_NUMBER} - ${currentBuild.currentResult}!",
    body: body_text

} */

def buildClosure(String name, LinkedHashMap build_results) {
                        return {
                            def runWrapper = build(job: name, propagate: true, wait: true)
                            build_results[name] = runWrapper
                        }
                    }