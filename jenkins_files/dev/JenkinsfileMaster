pipeline {
    agent { label 'kube_pod_slave' }
    environment {
        BODY_TEXT = ''
    }

    stages {
        /*stage('GitHub Checkout') {
            git credentialsId: 'sangita_id_rsa' ,
            url: 'ssh://git@github.ibm.com/CIO-MAP/Jenkins_Poc_mapetl.git', branch: 'master'  
        }*/
        stage('Kickoff Jobs') {
            steps {
                script{
                    def builds = [:]
                    //def build_results = [:]
                    echo "${build_results.getClass()}"
                    NAMES = "${JOB_NAMES}".split('\n')
                    //echo "${names.getClass()}"

                    for (x in NAMES) {
                        def name = x

                        builds[name] = buildClosure(name, build_results)
                        //def temp_build = builds[name]
                        //echo "${temp_build.getClass()}"
                    }
                    parallel builds

                    buildBody(names, build_results)
                }
            }
        }
        stage('Email Build Results') {
            steps {
                script {
                    emailext to: "caseyboerst@ibm.com",
                    subject: "${env.JOB_BASE_NAME} - Build # ${env.BUILD_NUMBER} - ${currentBuild.currentResult}!",
                    body: BODY_TEXT
                }
            }
        }
    }
}

def buildBody(String[] names, LinkedHashMap build_results) {
    for (name in names) {
        def key = name
        BODY_TEXT += key + " - Build " + build_results[key].getDisplayName() + " - " + build_results[key].getResult()

        if (build_results[key].getResult() == 'FAILURE') {
            BODY_TEXT += ": Check console output at " + build_results[key].getAbsoluteUrl() + " to view the results.\n"
        } else {
            BODY_TEXT += "\n"
        }
    }
}

/*
def sendEmail(String[] names, LinkedHashMap build_results) {
    emailext to: "caseyboerst@ibm.com",
    subject: "${env.JOB_BASE_NAME} - Build # ${env.BUILD_NUMBER} - ${currentBuild.currentResult}!",
    body: body_text

} */

def buildClosure(String name, LinkedHashMap build_results) {
                        return {
                            def runWrapper = build(job: name, propagate: true, wait: true)
                            build_results[name] = runWrapper
                        }
                    }